---
title: 【 数据库 】事务与分布式事务
date: 2016-02-10 16:06:49
tags: 数据库
---

# 事务

## 事务简介
本质：锁和并发，容易理解但性能较低。

单个事务单元：事务保证一致性，中间状态不会出现。ACID保证事务完整性。例如：从数据库中读取一行记录、向数据库中谢茹一行记录，同时更新这行记录的所有索引、删除整张表、加入索引、删除索引.... 所有对数据库的一个操作都是一个事务。

一组事务单元：事务单元之间的 Happen-before 关系（读写、写读、读读、写写）

### 事务 - 排队法
序列化读写，不需要冲突控制，慢速设备时，系统性能很低。

### 事务 - 排他锁
针对 `同一个单元` 的访问进行控制，例如：Bob 给 Smith 100元， Jack 给 Alice 100元，不发生冲突则可以并行。

### 事务 - 读写锁
分读锁和写锁，加大读时的并行度。可重复读能保证读读并行。
去掉读锁，只有写锁：读写 以及 写读可以并行，隔离性（隔离级别） 破坏了 一致性。

### 事务 - MVCC
本质是 copy on write，针对 `写读` 的优化，能够做到写不阻塞读，写时可以做到并发读。系统实现的复杂度会增加。

<br/>

## 事务处理常见问题
### 谁先谁后
方法：使用逻辑时间戳，可以保证事务本身的先后顺序。

### 故障恢复
业务属性不匹配 或 系统崩溃：事务回滚，需要恢复故障，在此期间不执行其他事务。

### 死锁与死锁检测
死锁产生的原因：两个线程、不同方向、相同资源。
解决方法：**碰撞检测**（将事务持有锁的情况存到内存中，检测到死锁，则终止一边事务）、等锁超时

<br/>

# 单机事务
## 事务的 ACID

### 原子性
一个事务要么同时成功，要么同时失败。原子性的保证方法：在 undo 日志中记录回滚段 undo 信息，正向操作的逆向操作。

### 一致性
Can( happen before )

## 单机事务的典型异常应对

## 事务的调优原则